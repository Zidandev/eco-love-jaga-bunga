<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Jaga Bunga dari Chika</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
  
  :root{
    --primary: #10B981;
    --primary-dark: #059669;
    --secondary: #34D399;
    --accent: #6EE7B7;
    --bg-start: #ECFDF5;
    --bg-end: #A7F3D0;
    --panel: rgba(255,255,255,0.95);
    --shadow: rgba(16, 185, 129, 0.2);
    --text-dark: #064E3B;
    --text-medium: #065F46;
  }
  
  * { box-sizing: border-box; }
  
  html,body{
    height:100%;margin:0;padding:0;
    font-family:'Poppins',system-ui,sans-serif;
    overflow:hidden;
  }
  
  body{
    background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
    display:flex;align-items:center;justify-content:center;
    -webkit-touch-callout:none;
    -webkit-user-select:none;
    user-select:none;
    position: relative;
  }
  
  body::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(52, 211, 153, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(110, 231, 183, 0.05) 0%, transparent 50%);
    pointer-events: none;
  }

  #wrap{
    width:100vw;height:100vh;position:relative;overflow:hidden;
  }

  /* Main menu with glassmorphism */
  #menu {
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(450px,92vw);padding:40px 35px;border-radius:24px;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 25px 60px rgba(16, 185, 129, 0.15),
                0 10px 30px rgba(0,0,0,0.1);
    text-align:center;z-index:50;
    animation: slideIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  @keyframes slideIn {
    0% { opacity: 0; transform: translate(-50%, -60%) scale(0.8); }
    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  }
  
  #menu h1{
    margin:0 0 12px;font-size:32px;color:var(--text-dark);
    font-weight:700;letter-spacing:-0.5px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  #menu p{margin:0 0 25px;color:var(--text-medium);line-height:1.6;font-weight:400;}
  
  .btn{
    display:inline-block;padding:14px 28px;margin:0 6px;
    border-radius:16px;background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color:white;font-weight:600;text-decoration:none;cursor:pointer;border:none;
    font-size:15px;font-family:inherit;
    box-shadow: 0 10px 25px var(--shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  .btn:hover::before {
    left: 100%;
  }
  
  .btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 15px 35px var(--shadow);
  }
  
  .btn:active{
    transform: translateY(0);
  }
  
  .btn.ghost{
    background:transparent;color:var(--primary);
    border:2px solid var(--primary);box-shadow:none;
  }
  
  .btn.ghost:hover{
    background:var(--primary);color:white;
    box-shadow: 0 10px 25px var(--shadow);
  }

  /* Modern HUD */
  #hud{
    position:absolute;left:20px;top:20px;z-index:40;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(15px);
    padding:12px 20px;border-radius:20px;
    border: 1px solid rgba(255,255,255,0.3);
    box-shadow:0 10px 30px rgba(16, 185, 129, 0.1);
    font-weight:600;color:var(--text-dark);
    font-size:16px;
    animation: fadeInDown 0.6s ease-out;
  }
  
  @keyframes fadeInDown {
    0% { opacity: 0; transform: translateY(-20px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  /* Canvas styling */
  canvas{
    display:block; width:100%; height:100%; 
    touch-action: none; 
    -webkit-tap-highlight-color: transparent;
  }

  /* End overlay with modern design */
  #endOverlay{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    z-index:60;width:90vw;max-width:420px;padding:35px 30px;
    border-radius:24px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    display:none;text-align:center;
    box-shadow:0 30px 80px rgba(16, 185, 129, 0.2),
               0 15px 40px rgba(0,0,0,0.1);
    animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }
  
  @keyframes popIn {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  }
  
  #endOverlay h2{
    margin:0 0 12px;color:var(--text-dark);
    font-size:28px;font-weight:700;
  }
  
  #endOverlay p{
    color:var(--text-medium);margin:0 0 25px;
    line-height:1.5;font-size:16px;
  }
  
  #endOverlay button{margin:0 6px;}

  /* Responsive design */
  @media (max-width: 480px) {
    #menu { padding: 30px 25px; }
    #menu h1 { font-size: 26px; }
    .btn { padding: 12px 20px; font-size: 14px; margin: 0 4px; }
    #hud { left: 15px; top: 15px; padding: 10px 16px; font-size: 14px; }
  }
</style>
</head>
<body>
  <div id="wrap">
    <canvas id="gameCanvas"></canvas>

    <div id="menu" aria-hidden="false">
      <h1>üå∏ Jaga Bunga ‚Äî Eco Love</h1>
      <p>Chika ingin mencabut bunga! Klik/tap Chika sebelum dia menyentuh bunga.<br>Target: <strong>100 poin</strong> untuk menang! üéØ</p>
      <div>
        <button id="btnStart" class="btn">üöÄ Mulai Game</button>
        <button id="btnHow" class="btn ghost">‚ùì Cara Main</button>
      </div>
      <p style="margin-top:18px;font-size:13px;color:#6B7280;opacity:0.8">Sentuh/klik untuk menyerang ‚Ä¢ Mobile & Desktop</p>
    </div>

    <div id="hud" aria-hidden="true">üèÜ Skor: <span id="score">0</span></div>

    <div id="endOverlay" role="dialog" aria-modal="true">
      <h2 id="endTitle">Hasil</h2>
      <p id="endText"></p>
      <div>
        <button id="btnRestart" class="btn">üîÑ Main Lagi</button>
        <button id="btnExit" class="btn ghost">‚ùå Keluar</button>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG & ASSETS ---------- */
const ASSETS = {
  chika: 'chika_idle.png',
  bunga: 'bunga.png'
};

const TARGET_SCORE = 100;
const BASE_SPAWN_MS = 1600;
const MIN_SPAWN_MS = 300;
const BASE_SPEED = 0.9;
const SPEED_INCREASE_PER_20 = 0.2;
const HIT_SCORE = 5;

/* ---------- CANVAS SETUP ---------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: true });
const dpr = Math.max(1, window.devicePixelRatio || 1);

let W = 1, H = 1;
function resize(){
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = Math.floor(W * dpr);
  canvas.height = Math.floor(H * dpr);
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resize, {passive:true});
resize();

/* ---------- STATE ---------- */
let score = 0;
let chikas = [];
let lastSpawn = 0;
let lastTime = performance.now();
let spawnInterval = BASE_SPAWN_MS;
let gameRunning = false;
let gameOver = false;
let bungaImg = new Image();
let chikaImg = new Image();
let particles = [];
let imagesLoaded = 0;
let totalToLoad = 2;

/* ---------- PRELOAD ---------- */
bungaImg.src = ASSETS.bunga;
bungaImg.onload = ()=>{ imagesLoaded++; };
chikaImg.src = ASSETS.chika;
chikaImg.onload = ()=>{ imagesLoaded++; };

/* ---------- UTILS ---------- */
function rand(min,max){ return Math.random()*(max-min)+min; }
function clamp(v,a,b){return Math.max(a, Math.min(b,v));}

/* ---------- GAME OBJECTS ---------- */
const center = ()=>({ x: W/2, y: H/2 });
const bungaRadius = Math.min(86, Math.min(W,H) * 0.09);

function spawnChika(){
  const side = Math.floor(Math.random()*4);
  let x,y;
  const margin = 60;
  if(side===0){ x = rand(-margin, W+margin); y = -120; }
  else if(side===1){ x = W + 120; y = rand(-margin, H+margin); }
  else if(side===2){ x = rand(-margin, W+margin); y = H + 120; }
  else { x = -120; y = rand(-margin, H+margin); }

  const size = Math.round(clamp(Math.min(W,H)*0.12, 48, 160));
  const c = center();
  const dx = c.x - x;
  const dy = c.y - y;
  const dist = Math.sqrt(dx*dx+dy*dy);
  const baseSpeed = BASE_SPEED + Math.floor(score / 20) * SPEED_INCREASE_PER_20;
  const speed = baseSpeed + rand(-0.2, 0.6);
  const vx = (dx/dist) * speed;
  const vy = (dy/dist) * speed;
  const id = Math.random().toString(36).slice(2);
  const rotation = Math.atan2(vy, vx);
  chikas.push({id,x,y,vx,vy,size,angle:rotation,bobOffset:rand(0,Math.PI*2)});
}

/* ---------- ENHANCED PARTICLES ---------- */
const particleColors = [
  '#FFD166', '#FF6B6B', '#4ECDC4', '#45B7D1', 
  '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF',
  '#5F27CD', '#00D2D3', '#FF9F43', '#10AC84'
];

function spawnParticles(x,y,isHit=true){
  const count = isHit ? 18 : 12;
  const colors = isHit ? particleColors : ['#FF6B6B', '#FF8E8E', '#FFA8A8'];
  
  for(let i=0;i<count;i++){
    const angle = (Math.PI * 2 * i) / count + rand(-0.3, 0.3);
    const speed = rand(1.5, 4);
    const color = colors[Math.floor(Math.random() * colors.length)];
    
    particles.push({
      x: x + rand(-12,12),
      y: y + rand(-12,12),
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - rand(0.5, 2),
      life: 45 + Math.round(rand(0,25)),
      age: 0,
      size: rand(3,8),
      color: color,
      gravity: rand(0.08, 0.15),
      bounce: rand(0.3, 0.7),
      rotation: rand(0, Math.PI * 2),
      rotSpeed: rand(-0.2, 0.2)
    });
  }
}

function spawnFloatingParticles(){
  // Ambient floating particles
  if(Math.random() < 0.3){
    particles.push({
      x: rand(-50, W + 50),
      y: H + 20,
      vx: rand(-0.5, 0.5),
      vy: rand(-1.5, -0.5),
      life: 120 + rand(0, 60),
      age: 0,
      size: rand(2, 5),
      color: particleColors[Math.floor(Math.random() * particleColors.length)],
      gravity: -0.01,
      bounce: 0,
      rotation: 0,
      rotSpeed: rand(-0.1, 0.1),
      alpha: rand(0.3, 0.7)
    });
  }
}

/* ---------- ENHANCED RENDER ---------- */
function draw(){
  // Clear with subtle gradient
  const gradient = ctx.createLinearGradient(0, 0, 0, H);
  gradient.addColorStop(0, 'rgba(236, 253, 245, 0.3)');
  gradient.addColorStop(1, 'rgba(167, 243, 208, 0.3)');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, W, H);

  // Bunga with enhanced shadow
  const c = center();
  const br = bungaRadius;
  
  // Multi-layer shadow
  ctx.beginPath();
  ctx.fillStyle = 'rgba(16, 185, 129, 0.1)';
  ctx.ellipse(c.x, c.y + br*0.5, br*0.9, br*0.4, 0, 0, Math.PI*2);
  ctx.fill();
  
  ctx.beginPath();
  ctx.fillStyle = 'rgba(0,0,0,0.08)';
  ctx.ellipse(c.x, c.y + br*0.4, br*0.8, br*0.3, 0, 0, Math.PI*2);
  ctx.fill();

  // Bunga image with glow effect
  ctx.shadowColor = 'rgba(16, 185, 129, 0.3)';
  ctx.shadowBlur = 15;
  const bw = br*2;
  ctx.drawImage(bungaImg, c.x - bw/2, c.y - bw/2, bw, bw);
  ctx.shadowBlur = 0;

  // Chikas with animation
  const time = performance.now();
  chikas.forEach(ch => {
    const w = ch.size;
    const h = ch.size;
    const bobAmount = Math.sin(time * 0.005 + ch.bobOffset) * 3;
    
    ctx.save();
    ctx.translate(ch.x, ch.y + bobAmount);
    ctx.rotate(ch.angle + Math.sin(time * 0.008 + ch.bobOffset) * 0.1);
    
    // Shadow under chika
    ctx.globalAlpha = 0.3;
    ctx.drawImage(chikaImg, -w/2 + 2, -h/2 + 2, w, h);
    ctx.globalAlpha = 1;
    
    // Main chika
    ctx.drawImage(chikaImg, -w/2, -h/2, w, h);
    ctx.restore();
  });

  // Enhanced particles with rotation and effects
  particles.forEach(p=>{
    const ageRatio = p.age / p.life;
    const alpha = p.alpha || (1 - ageRatio);
    ctx.globalAlpha = Math.max(0, alpha);
    
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rotation);
    
    const size = p.size * (1 - ageRatio * 0.5);
    
    // Glow effect for some particles
    if(p.size > 5){
      ctx.shadowColor = p.color;
      ctx.shadowBlur = 8;
    }
    
    ctx.beginPath();
    ctx.fillStyle = p.color;
    ctx.arc(0, 0, size, 0, Math.PI*2);
    ctx.fill();
    
    ctx.shadowBlur = 0;
    ctx.restore();
    ctx.globalAlpha = 1;
  });
}

/* ---------- ENHANCED UPDATE ---------- */
function update(dt){
  if(!gameRunning || gameOver) return;

  // Spawn logic
  const now = performance.now();
  if(now - lastSpawn > spawnInterval){
    spawnChika();
    lastSpawn = now;
    const scale = clamp(1 - score/140, 0.15, 1);
    spawnInterval = Math.max(MIN_SPAWN_MS, BASE_SPAWN_MS * scale * (0.85 + Math.random()*0.3));
  }

  // Move chikas
  const c = center();
  for(let i = chikas.length -1; i>=0; i--){
    const ch = chikas[i];
    ch.x += ch.vx * (dt/16.67);
    ch.y += ch.vy * (dt/16.67);
    
    // Check collision with bunga
    const dx = ch.x - c.x;
    const dy = ch.y - c.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < bungaRadius * 0.9){
      // Collision effect
      spawnParticles(c.x, c.y, false);
      lose();
      return;
    }
    
    // Remove off-screen chikas
    if(ch.x < -200 || ch.x > W+200 || ch.y < -200 || ch.y > H+200){
      chikas.splice(i,1);
    }
  }

  // Update particles with physics
  for(let i = particles.length-1; i>=0; i--){
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += p.gravity;
    p.rotation += p.rotSpeed;
    p.age++;
    
    // Simple ground bounce
    if(p.y > H - 20 && p.vy > 0 && p.bounce > 0){
      p.vy *= -p.bounce;
      p.vx *= 0.8;
    }
    
    if(p.age >= p.life || p.y > H + 50) particles.splice(i,1);
  }
  
  // Spawn ambient particles
  spawnFloatingParticles();
}

/* ---------- INPUT HANDLING ---------- */
function onPointer(e){
  if(!gameRunning || gameOver) return;
  e.preventDefault();
  
  const rect = canvas.getBoundingClientRect();
  const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
  const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
  const x = clientX - rect.left;
  const y = clientY - rect.top;

  // Check hit on chikas
  for(let i = chikas.length-1; i>=0; i--){
    const ch = chikas[i];
    const dx = x - ch.x;
    const dy = y - ch.y;
    const r = ch.size * 0.45;
    if(dx*dx + dy*dy <= r*r){
      // Hit effect
      chikas.splice(i,1);
      score += HIT_SCORE;
      document.getElementById('score').textContent = score;
      spawnParticles(x, y, true);
      
      // Screen shake effect (subtle)
      canvas.style.transform = 'translate(' + rand(-2,2) + 'px,' + rand(-2,2) + 'px)';
      setTimeout(()=> canvas.style.transform = '', 100);
      
      if(score >= TARGET_SCORE) win();
      return;
    }
  }
}

/* ---------- WIN / LOSE ---------- */
function win(){
  gameOver = true;
  // Victory particle explosion
  const c = center();
  for(let i = 0; i < 50; i++){
    spawnParticles(c.x + rand(-100, 100), c.y + rand(-100, 100), true);
  }
  
  showEnd(true, `üéâ Kamu berhasil menjaga bunga dari Chika!\nüèÜ Skor Final: ${score}`, "üåü KAMU MENANG! üåü");
  
  setTimeout(()=> {
    try{
      if(window.renpy && typeof window.renpy.return === 'function'){
        window.renpy.return(score);
      }
    }catch(e){}
    try{ window.close(); }catch(e){}
  }, 250);
}

function lose(){
  gameOver = true;
  showEnd(false, `üíî Bunganya berhasil dicabut oleh Chika!\nüìä Skor Akhir: ${score}`, "üò¢ Kalah!");
  setTimeout(()=> {
    try{
      if(window.renpy && typeof window.renpy.return === 'function'){
        window.renpy.return(0);
      }
    }catch(e){}
  }, 200);
}

/* ---------- UI FUNCTIONS ---------- */
const endOverlay = document.getElementById('endOverlay');
const endTitle = document.getElementById('endTitle');
const endText = document.getElementById('endText');

function showEnd(winFlag, text, title){
  endTitle.textContent = title;
  endText.textContent = text;
  endOverlay.style.display = 'block';
}

/* ---------- GAME LOOP ---------- */
function gameLoop(ts){
  const now = ts || performance.now();
  const dt = now - lastTime;
  lastTime = now;
  update(dt);
  draw();
  if(!gameOver) requestAnimationFrame(gameLoop);
}

/* ---------- GAME CONTROL ---------- */
function startGame(){
  if(imagesLoaded < totalToLoad){
    setTimeout(startGame, 150);
    return;
  }
  
  document.getElementById('menu').style.display = 'none';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('hud').setAttribute('aria-hidden','false');
  
  // Reset game state
  score = 0;
  document.getElementById('score').textContent = score;
  chikas = [];
  particles = [];
  spawnInterval = BASE_SPAWN_MS;
  gameRunning = true;
  gameOver = false;
  lastSpawn = performance.now() - 400;
  lastTime = performance.now();
  
  // Start game loop
  requestAnimationFrame(gameLoop);
  
  // Bind events
  canvas.addEventListener('click', onPointer);
  canvas.addEventListener('touchstart', onPointer, {passive:false});
}

function restart(){
  endOverlay.style.display = 'none';
  document.getElementById('hud').style.display = 'none';
  document.getElementById('menu').style.display = 'block';
  
  // Reset everything
  chikas = [];
  particles = [];
  score = 0;
  gameOver = false;
  gameRunning = false;
  spawnInterval = BASE_SPAWN_MS;
  document.getElementById('score').textContent = '0';
  canvas.style.transform = '';
}

/* ---------- EVENT LISTENERS ---------- */
document.getElementById('btnStart').addEventListener('click', startGame);
document.getElementById('btnHow').addEventListener('click', ()=>{
  alert("üéØ CARA BERMAIN:\n\nüñ±Ô∏è Klik/tap setiap Chika untuk mengusirnya\nüå∏ Jangan biarkan Chika menyentuh bunga di tengah\nüèÜ Kumpulkan 100 poin untuk menang\n‚ö° Semakin tinggi skor, semakin cepat Chika datang!\n\nüí° Tips: Aim dengan baik dan jaga fokus!");
});
document.getElementById('btnRestart').addEventListener('click', restart);
document.getElementById('btnExit').addEventListener('click', ()=>{
  try{ window.close(); }catch(e){}
});

/* ---------- INITIALIZATION ---------- */
resize();
document.getElementById('hud').style.display = 'none';
</script>
</body>
</html>